<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ç¾å®¹å®¤åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ã‚¯ãƒ©ã‚¦ãƒ‰ç‰ˆï¼ˆOCRå¯¾å¿œ å®Œå…¨ç‰ˆï¼‰</title>

<!-- å¯ç”¨ãƒ•ãƒ©ã‚° -->
<script>
  window.firebaseAvailable = false;
  window.papaParseAvailable = false;
  window.tesseractAvailable = false;
</script>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js" onload="window.firebaseAvailable=true" onerror="console.warn('Firebase app load error')"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js" onerror="console.warn('Firestore load error')"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js" onerror="console.warn('Auth load error')"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" onload="window.papaParseAvailable=true" onerror="console.warn('PapaParse load error')"></script>
<script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js" onerror="console.warn('piexifjs load error')"></script>
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js" onload="window.tesseractAvailable=true" onerror="console.warn('Tesseract load error')"></script>

<style>
  * { box-sizing: border-box; }
  body { margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#f6f7fb; color:#222; }
  .container { max-width:1200px; margin:0 auto; padding:20px; }
  .card { background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08); overflow:hidden; margin-bottom:20px; }
  .card-hd { padding:18px 20px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; }
  .card-bd { padding:20px; }
  .btn { border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; }
  .btn-primary { background:linear-gradient(135deg,#ec4899,#8b5cf6); color:#fff; }
  .btn-secondary { background:#6b7280; color:#fff; }
  .btn-danger { background:#dc2626; color:#fff; }
  .tag { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  .tag-blue { background:#e0e7ff; color:#3730a3; }
  .tag-green { background:#d1fae5; color:#065f46; }
  .tag-orange { background:#ffedd5; color:#9a3412; }
  .tag-purple { background:#f3e8ff; color:#6b21a8; }
  table { width:100%; border-collapse:collapse; }
  th,td { padding:10px 8px; border-bottom:1px solid #eee; text-align:left; }
  th { background:#fafafa; font-size:12px; letter-spacing:.04em; text-transform:uppercase; color:#6b7280; }
  input,select { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px; }
  .row { display:grid; gap:12px; grid-template-columns: repeat(4,1fr); }
  .row-2 { grid-template-columns: repeat(2,1fr); }
  .row-3 { grid-template-columns: repeat(3,1fr); }
  .hidden { display:none; }
  .toast { position:fixed; right:16px; bottom:16px; background:#111; color:#fff; padding:10px 14px; border-radius:999px; opacity:0; transition:.25s; }
  .toast.show { opacity:1; }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:1000; }
  .modal.show { display:flex; }
  .modal-inner { width:min(95vw,900px); max-height:90vh; overflow:auto; background:#fff; border-radius:16px; }
  .modal-hd { padding:16px 18px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; }
  .modal-bd { padding:18px; }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .hdr { background:linear-gradient(135deg,#ec4899,#8b5cf6); color:#fff; padding:22px; }
  .hdr .sub { opacity:.9; }

  /* ã‚¿ãƒ– */
  .tabs { display:flex; gap:6px; margin:16px 0; flex-wrap:wrap; }
  .tab { background:#fff; padding:10px 14px; border-radius:10px; border:1px solid #eee; cursor:pointer; }
  .tab.active { background:#8b5cf6; color:#fff; border-color:#8b5cf6; }

  /* OCRãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
  .ocr-preview { text-align:center; }
  .ocr-preview img { max-width:100%; max-height:360px; border-radius:8px; border:1px solid #eee; }
  .ocr-loading { text-align:center; padding:24px; }
  .spinner { width:46px; height:46px; border:3px solid #eee; border-top:3px solid #8b5cf6; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto; }
  @keyframes spin { to { transform: rotate(360deg);} }
</style>
</head>
<body>

<div class="hdr">
  <div class="container">
    <h1 style="margin:0;">ç¾å®¹å®¤åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  â˜ï¸</h1>
    <div class="sub">ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ & OCRèª­ã¿å–ã‚Šï¼ˆVSCodeè²¼ä»˜ã‘ç”¨ å®Œå…¨ç‰ˆï¼‰</div>
  </div>
</div>

<div class="container">
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
  <div id="loginCard" class="card">
    <div class="card-hd"><strong>ãƒ­ã‚°ã‚¤ãƒ³</strong><span id="modeText" class="tag tag-purple">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰</span></div>
    <div class="card-bd">
      <div class="row row-3">
        <div><label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label><input id="loginUsername" value="admin"/></div>
        <div><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input id="loginPassword" type="password" value="password"/></div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <button class="btn btn-primary" onclick="login(event)">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button class="btn btn-secondary" onclick="showFirebaseSetup()">ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®š</button>
        </div>
      </div>
      <div style="margin-top:10px; font-size:12px; color:#6b7280">
        ãƒ‡ãƒ¢ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼å <b>admin</b> / ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <b>password</b>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ -->
  <div id="app" class="hidden">
    <div class="card">
      <div class="card-hd">
        <div>
          <strong>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</strong>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <span id="cloudStatus" class="tag tag-blue">æœªæ¥ç¶š</span>
          <button class="btn btn-primary" onclick="saveToCloud()">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜</button>
          <button class="btn" onclick="loadCloudData()">ğŸ”„ æœ€æ–°å–å¾—</button>
          <button class="btn btn-danger" onclick="clearCloudData()">ğŸ—‘ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰å…¨å‰Šé™¤</button>
          <button class="btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
      <div class="card-bd">
        <div class="row row-4">
          <div><div>ç·å•†å“æ•°</div><h2 id="kpiProducts" style="margin:.25em 0">0</h2></div>
          <div><div>è¦æ³¨æ„åœ¨åº«ï¼ˆ0ä»¥ä¸‹ï¼‰</div><h2 id="kpiLow" style="margin:.25em 0">0</h2></div>
          <div><div>é©æ­£åœ¨åº«ï¼ˆ>0ï¼‰</div><h2 id="kpiOk" style="margin:.25em 0">0</h2></div>
          <div><div>æ£šå¸é‡‘é¡</div><h2 id="kpiValue" style="margin:.25em 0">Â¥0</h2></div>
        </div>
      </div>
    </div>

    <!-- ã‚¿ãƒ– -->
    <div class="tabs">
      <div class="tab active" data-tab="products" onclick="switchTab(event,'products')">ğŸ“¦ å•†å“ãƒã‚¹ã‚¿</div>
      <div class="tab" data-tab="staff" onclick="switchTab(event,'staff')">ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿</div>
      <div class="tab" data-tab="transactions" onclick="switchTab(event,'transactions')">ğŸ“‹ å–å¼•è¨˜éŒ²</div>
      <div class="tab" data-tab="reports" onclick="switchTab(event,'reports')">ğŸ“ˆ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</div>
      <div class="tab" data-tab="settings" onclick="switchTab(event,'settings')">âš™ï¸ è¨­å®š</div>
    </div>

    <!-- å•†å“ -->
    <div id="tab-products" class="card">
      <div class="card-hd">
        <strong>å•†å“ãƒã‚¹ã‚¿</strong>
        <div style="display:flex; gap:8px;">
          <button class="btn" onclick="showAddProduct()">â• è¿½åŠ </button>
          <button class="btn btn-secondary" onclick="showCsvModal('products')">ğŸ“¤ CSVä¸€æ‹¬</button>
          <button class="btn btn-danger" onclick="deleteAllProducts()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
        </div>
      </div>
      <div class="card-bd">
        <div id="addProductArea" class="hidden">
          <div class="row row-4" style="margin-bottom:10px;">
            <div><label>å•†å“å</label><input id="productName"/></div>
            <div><label>é©æ­£åœ¨åº«</label><input id="optimalStock" type="number"/></div>
            <div><label>å˜ä¾¡</label><input id="unitPrice" type="number"/></div>
            <div><label>ä»•å…¥å…ˆ</label><input id="supplier"/></div>
          </div>
          <div class="row row-2" style="margin-bottom:12px;">
            <div><label>ã‚«ãƒ†ã‚´ãƒª</label>
              <select id="category">
                <option>ã‚«ãƒ©ãƒ¼å‰¤</option><option>ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼</option><option>ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ</option>
                <option>ãƒ‘ãƒ¼ãƒæ¶²</option><option>ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°</option><option>ãã®ä»–</option>
              </select>
            </div>
            <div><label>ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆOCRè¡¨è¨˜ã‚†ã‚Œå¯¾ç­–, ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label><input id="alias"/></div>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-primary" onclick="addProduct()">è¿½åŠ </button>
            <button class="btn" onclick="hideAddProduct()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
          <hr style="margin:16px 0;">
        </div>

        <table>
          <thead><tr>
            <th>å•†å“å</th><th>ä»•å…¥å…ˆ</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>ç¾åœ¨åº«</th><th>é©æ­£åœ¨åº«</th><th>å˜ä¾¡</th><th>æ“ä½œ</th>
          </tr></thead>
          <tbody id="productsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒƒãƒ• -->
    <div id="tab-staff" class="card hidden">
      <div class="card-hd">
        <strong>ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿</strong>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-secondary" onclick="showCsvModal('staff')">ğŸ“¤ CSVä¸€æ‹¬</button>
        </div>
      </div>
      <div class="card-bd">
        <table>
          <thead><tr><th>ã‚³ãƒ¼ãƒ‰</th><th>æ°å</th><th>å½¹è·</th><th>å…¥ç¤¾æ—¥</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="staffTable"></tbody>
        </table>
      </div>
    </div>

    <!-- å–å¼• -->
    <div id="tab-transactions" class="card hidden">
      <div class="card-hd">
        <strong>å–å¼•è¨˜éŒ²</strong>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-secondary" onclick="openOCRModal()">ğŸ“¸ OCRå–ã‚Šè¾¼ã¿</button>
          <button class="btn" onclick="showAddTransaction()">â• å–å¼•è¿½åŠ </button>
        </div>
      </div>
      <div class="card-bd">
        <div id="addTransactionArea" class="hidden" style="margin-bottom:14px;">
          <div class="row row-3">
            <div><label>å•†å“</label><select id="transactionProduct"></select></div>
            <div><label>ç¨®åˆ¥</label>
              <select id="transactionType">
                <option value="order">ç™ºæ³¨</option>
                <option value="receipt">å…¥è·</option>
                <option value="use" selected>ä½¿ç”¨</option>
                <option value="sale">è²©å£²</option>
              </select>
            </div>
            <div><label>æ•°é‡</label><input id="transactionQuantity" type="number"/></div>
          </div>
          <div class="row row-3" style="margin-top:10px;">
            <div><label>æ‹…å½“</label><select id="transactionStaff"></select></div>
            <div><label>ãƒ¡ãƒ¢</label><input id="transactionMemo"/></div>
            <div style="display:flex; align-items:flex-end; gap:8px;">
              <button class="btn btn-primary" onclick="addTransaction()">è¿½åŠ </button>
              <button class="btn" onclick="hideAddTransaction()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>
          <hr style="margin:16px 0;">
        </div>

        <table>
          <thead><tr>
            <th>æ—¥æ™‚</th><th>å•†å“</th><th>ç¨®åˆ¥</th><th>æ•°é‡</th><th>æ‹…å½“</th><th>ãƒ¡ãƒ¢</th><th>æ“ä½œ</th>
          </tr></thead>
          <tbody id="transactionsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- ãƒ¬ãƒãƒ¼ãƒˆ -->
    <div id="tab-reports" class="card hidden">
      <div class="card-hd"><strong>æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</strong></div>
      <div class="card-bd">
        <div class="row row-4">
          <div><div>å½“æœˆç™ºæ³¨é¡</div><h2 id="monthlyAmount">Â¥0</h2></div>
          <div><div>ä»•å…¥å…ˆæ•°</div><h2 id="supplierCount">0</h2></div>
          <div><div>å–å¼•ä»¶æ•°</div><h2 id="transactionCount">0</h2></div>
          <div><div>æœ€çµ‚æ›´æ–°</div><h2 id="lastUpdate">-</h2></div>
        </div>
        <div style="margin-top:10px;">
          <table>
            <thead><tr><th>ä»•å…¥å…ˆ</th><th>é‡‘é¡</th><th>å‰²åˆ</th><th>å›æ•°</th><th>å¹³å‡å˜ä¾¡</th></tr></thead>
            <tbody id="supplierReport"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- è¨­å®š -->
    <div id="tab-settings" class="card hidden">
      <div class="card-hd"><strong>è¨­å®š</strong></div>
      <div class="card-bd">
        <div class="row row-3">
          <div>å•†å“: <b id="statProducts">0</b></div>
          <div>ã‚¹ã‚¿ãƒƒãƒ•: <b id="statStaff">0</b></div>
          <div>å–å¼•: <b id="statTransactions">0</b></div>
        </div>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button class="btn" onclick="exportData()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button class="btn" onclick="importData()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebaseè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="firebaseModal" class="modal">
  <div class="modal-inner">
    <div class="modal-hd">
      <strong>Firebaseè¨­å®š</strong>
      <button class="btn" onclick="closeFirebaseSetup()">âœ•</button>
    </div>
    <div class="modal-bd">
      <p>Firebase Consoleã§ä½œæˆã—ãŸWebã‚¢ãƒ—ãƒªã®è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
      <textarea id="firebaseConfig" rows="10" style="width:100%; font-family:monospace;"></textarea>
      <div style="margin-top:10px; display:flex; gap:8px;">
        <button class="btn btn-primary" onclick="setupFirebase()">æ¥ç¶š</button>
        <button class="btn" onclick="useLocalMode()">ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½¿ã†</button>
      </div>
    </div>
  </div>
</div>

<!-- OCRãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="ocrModal" class="modal">
  <div class="modal-inner">
    <div class="modal-hd">
      <strong>ğŸ“¸ ä½¿ç”¨è¨˜éŒ²ã®èª­ã¿å–ã‚Šï¼ˆOCRï¼‰</strong>
      <button class="btn" onclick="closeOCRModal()">âœ•</button>
    </div>
    <div class="modal-bd">
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
        <input id="ocrFile" type="file" accept="image/*" style="display:none" onchange="handleOCRFile(event)"/>
        <button class="btn btn-primary" onclick="document.getElementById('ocrFile').click()">ç”»åƒã‚’é¸æŠ</button>
        <button class="btn" onclick="printOCRTemplate()">ğŸ–¨ï¸ è¨˜éŒ²ç”¨ç´™ã‚’å°åˆ·</button>
        <select id="ocrStaffSelect" style="max-width:240px;">
          <option value="">æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠ</option>
        </select>
      </div>
      <div id="ocrPreview" class="ocr-preview hidden"></div>
      <div id="ocrLoading" class="ocr-loading hidden">
        <div class="spinner"></div>
        <div style="margin-top:10px;">ç”»åƒã‚’è§£æä¸­...</div>
      </div>
      <div id="ocrResults" class="hidden">
        <h3>èªè­˜çµæœã®ç¢ºèª</h3>
        <table>
          <thead><tr><th>å•†å“åï¼ˆå€™è£œï¼‰</th><th>æ•°é‡</th><th>å˜ä½</th><th></th></tr></thead>
          <tbody id="ocrTableBody"></tbody>
        </table>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button class="btn" onclick="addOCRRow()">â• è¡Œã‚’è¿½åŠ </button>
          <button class="btn btn-primary" onclick="confirmOCRRecords()">âœ… ç¢ºå®šã—ã¦è¨˜éŒ²</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"><span id="toastText"></span></div>

<script>
/* =========================
   0) çŠ¶æ…‹
========================= */
let isCloudMode = false;
let db = null;
let currentUser = null;

// ãƒ‡ãƒ¼ã‚¿ï¼ˆç©ºã§æŒã¤ï¼‰: ã‚µãƒ³ãƒ—ãƒ«ã¯ãƒ­ãƒ¼ã‚«ãƒ«åˆå›ã®ã¿æŠ•å…¥
let products = [];
let staff = [];
let transactions = [];

// ç·¨é›†ä¸­
let editingProductId = null;
let currentCsvType = 'products';

/* =========================
   1) ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
========================= */
function showToast(msg){ const t=document.getElementById('toast'); document.getElementById('toastText').textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
function byId(id){ return document.getElementById(id); }
function saveLocal(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
function loadLocal(key, def=null){ try{ const s=localStorage.getItem(key); return s? JSON.parse(s): def; }catch(e){ return def; } }
function fmtYmd(dt){ return dt.toISOString().slice(0,10); }
function fmtHm(dt){ return dt.toTimeString().slice(0,5); }

/* =========================
   2) Firebase è¨­å®š
========================= */
function showFirebaseSetup(){ byId('firebaseModal').classList.add('show'); }
function closeFirebaseSetup(){ byId('firebaseModal').classList.remove('show'); }
function useLocalMode(){
  isCloudMode=false;
  byId('modeText').textContent='ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰';
  byId('cloudStatus').textContent='ãƒ­ãƒ¼ã‚«ãƒ«';
  closeFirebaseSetup();
}
function setupFirebase(){
  if(!window.firebaseAvailable){ alert('FirebaseãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“'); return; }
  const txt = byId('firebaseConfig').value.trim();
  if(!txt){ alert('è¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„'); return; }
  try{
    const cfg = txt.startsWith('{') ? eval('('+txt+')') : JSON.parse(txt);
    firebase.initializeApp(cfg);
    db = firebase.firestore();
    isCloudMode = true;
    saveLocal('firebaseConfig', cfg);
    byId('modeText').textContent='ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ';
    byId('cloudStatus').textContent='æ¥ç¶šæ¸ˆã¿';
    closeFirebaseSetup();
    showToast('âœ… Firebaseæ¥ç¶šå®Œäº†');
  }catch(e){
    alert('è¨­å®šã‚¨ãƒ©ãƒ¼: '+e.message);
  }
}

/* =========================
   3) èªè¨¼ï¼ˆç°¡æ˜“ï¼‰
========================= */
let users = loadLocal('beautyInventoryUsers', { admin:{ password:'password', displayName:'ç®¡ç†è€…' } });

async function login(ev){
  if(ev) ev.preventDefault();
  const u = byId('loginUsername').value.trim();
  const p = byId('loginPassword').value.trim();
  if(!users[u] || users[u].password !== p){ alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'); return; }
  currentUser = u;

  // å…ˆã«ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ãƒ­ãƒ¼ãƒ‰ â†’ åˆæœŸåŒ–æç”»
  if(isCloudMode){
    await loadCloudData();
  }
  initializeApp(); // ãƒ­ãƒ¼ã‚«ãƒ« or ã‚¯ãƒ©ã‚¦ãƒ‰ã®ç¾çŠ¶ã‚’æç”»

  byId('loginCard').classList.add('hidden');
  byId('app').classList.remove('hidden');
  showToast('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');
}

function logout(){
  currentUser=null;
  byId('app').classList.add('hidden');
  byId('loginCard').classList.remove('hidden');
}

/* =========================
   4) åˆæœŸåŒ–ï¼†æç”»
========================= */
function seedLocalSamples_(){
  products = [
    { id:1, name:'ãƒ­ãƒ¬ã‚¢ãƒ« ã‚«ãƒ©ãƒ¼å‰¤ 6ç•ª', category:'ã‚«ãƒ©ãƒ¼å‰¤', currentStock:15, optimalStock:20, unitPrice:1200, supplier:'ãƒ­ãƒ¬ã‚¢ãƒ«', alias:'' },
    { id:2, name:'ãƒŸãƒ«ãƒœãƒ³ ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼', category:'ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼', currentStock:8, optimalStock:12, unitPrice:2800, supplier:'ãƒŸãƒ«ãƒœãƒ³', alias:'MILBON' },
    { id:3, name:'ã‚¦ã‚¨ãƒ© ãƒ‘ãƒ¼ãƒæ¶²', category:'ãƒ‘ãƒ¼ãƒæ¶²', currentStock:5, optimalStock:10, unitPrice:1800, supplier:'ã‚¦ã‚¨ãƒ©', alias:'WELLA' },
    { id:4, name:'N. ã‚ªã‚¤ãƒ«', category:'ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°', currentStock:25, optimalStock:15, unitPrice:3400, supplier:'ãƒŠãƒ—ãƒ©', alias:'Nãƒ‰ãƒƒãƒˆ' }
  ];
  staff = [
    { id:1, name:'ç”°ä¸­ç¾é¦™', role:'åº—é•·', staffCode:'ST001', joinDate:'2020-04-01' },
    { id:2, name:'ä½è—¤èŠ±å­', role:'ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ', staffCode:'ST002', joinDate:'2021-06-15' },
    { id:3, name:'å±±ç”°å¤ªéƒ', role:'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ', staffCode:'ST003', joinDate:'2023-03-01' }
  ];
  transactions = [];
}

function initializeApp(){
  // ãƒ­ãƒ¼ã‚«ãƒ«ï¼šæœªä¿å­˜ãªã‚‰åˆå›ã‚µãƒ³ãƒ—ãƒ«æŠ•å…¥ï¼ˆ1å›ã ã‘ï¼‰
  if(!isCloudMode){
    const saved = loadLocal('beautyInventoryData');
    if(saved){
      products = saved.products || [];
      staff = saved.staff || [];
      transactions = saved.transactions || [];
    }else if(!localStorage.getItem('seededV1')){
      seedLocalSamples_();
      localStorage.setItem('seededV1','true');
      saveAllData();
    }
  }

  renderProducts();
  renderStaff();
  renderTransactions();
  refreshSelectors();
  updateDashboard();
  updateReport();
  updateStats();

  byId('cloudStatus').textContent = isCloudMode ? 'ã‚¯ãƒ©ã‚¦ãƒ‰' : 'ãƒ­ãƒ¼ã‚«ãƒ«';
}

function switchTab(ev, name){
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  ev.currentTarget.classList.add('active');
  ['products','staff','transactions','reports','settings'].forEach(id=>{
    byId('tab-'+id).classList.add('hidden');
  });
  byId('tab-'+name).classList.remove('hidden');
  if(name==='reports') updateReport();
  if(name==='settings') updateStats();
}

/* =========================
   5) ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜/èª­è¾¼
========================= */
function saveAllData(){
  saveLocal('beautyInventoryData', {
    products, staff, transactions, savedAt: new Date().toISOString(), version:'1.0'
  });
  saveLocal('beautyInventoryUsers', users);
}

/* =========================
   6) ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ
========================= */
let syncInProgress = false;

async function saveToCloud(){
  if(!isCloudMode || !db){ saveAllData(); showToast('ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜'); return; }
  if(syncInProgress){ showToast('â³ åŒæœŸä¸­...'); return; }
  syncInProgress=true;
  try{
    const batch = db.batch();
    products.forEach(p=> batch.set(db.collection('products').doc(String(p.id)), p));
    staff.forEach(s=> batch.set(db.collection('staff').doc(String(s.id)), s));
    transactions.forEach(t=> batch.set(db.collection('transactions').doc(String(t.id)), t));
    await batch.commit();
    showToast('â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜å®Œäº†');
  }catch(e){
    alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: '+e.message);
  }finally{
    syncInProgress=false;
  }
}

async function loadCloudData(){
  if(!isCloudMode || !db){ // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ãƒ¼ãƒ‰
    const saved = loadLocal('beautyInventoryData');
    if(saved){ products=saved.products||[]; staff=saved.staff||[]; transactions=saved.transactions||[]; }
    return;
  }
  if(syncInProgress) return;
  syncInProgress=true;
  try{
    for(const col of ['products','staff','transactions']){
      window[col] = []; // â˜… å¿…ãšå…ˆã«ç©ºã«
      const snapshot = await db.collection(col).get();
      snapshot.forEach(doc => window[col].push(doc.data()));
    }
    // ä¸¦ã¹æ›¿ãˆ
    products.sort((a,b)=>a.id-b.id);
    staff.sort((a,b)=>a.id-b.id);
    transactions.sort((a,b)=>b.id-a.id);
    // æç”»æ›´æ–°
    if(byId('app') && !byId('app').classList.contains('hidden')){
      renderProducts(); renderStaff(); renderTransactions(); refreshSelectors(); updateDashboard(); updateReport();
    }
    showToast('ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰èª­è¾¼å®Œäº†');
  }catch(e){
    alert('èª­è¾¼ã‚¨ãƒ©ãƒ¼: '+e.message);
  }finally{
    syncInProgress=false;
  }
}

async function clearCloudData(){
  if(!isCloudMode || !db){ alert('ã‚¯ãƒ©ã‚¦ãƒ‰æœªæ¥ç¶š'); return; }
  if(!confirm('âš ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  try{
    const batch = db.batch();
    for(const col of ['products','staff','transactions']){
      const snap = await db.collection(col).get();
      snap.forEach(doc => batch.delete(doc.ref));
    }
    await batch.commit();
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚å³æ™‚ã‚¯ãƒªã‚¢ï¼†æç”»
    products=[]; staff=[]; transactions=[];
    saveAllData();
    renderProducts(); renderStaff(); renderTransactions(); refreshSelectors(); updateDashboard(); updateReport(); updateStats();
    showToast('ğŸ—‘ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ å®Œäº†');
  }catch(e){
    alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: '+e.message);
  }
}

/* =========================
   7) ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰/ãƒ¬ãƒãƒ¼ãƒˆ
========================= */
function updateDashboard(){
  const low = products.filter(p => (p.currentStock - p.optimalStock) < 0).length;
  const ok = products.length - low;
  const value = products.reduce((s,p)=> s + (p.currentStock*p.unitPrice||0), 0);
  byId('kpiProducts').textContent = products.length;
  byId('kpiLow').textContent = low;
  byId('kpiOk').textContent = ok;
  byId('kpiValue').textContent = 'Â¥'+ value.toLocaleString();
}

function calcMonthly(){
  const ym = new Date().toISOString().slice(0,7);
  const tx = transactions.filter(t=> t.type==='order' && (t.date||'').startsWith(ym));
  let total=0; const totals={}, counts={}, qtys={};
  const details=[];
  tx.forEach(t=>{
    const p = products.find(x=>x.id===t.productId);
    if(!p || !p.supplier) return;
    const amount = (p.unitPrice||0) * (t.quantity||0);
    total += amount;
    totals[p.supplier] = (totals[p.supplier]||0)+amount;
    counts[p.supplier] = (counts[p.supplier]||0)+1;
    qtys[p.supplier]   = (qtys[p.supplier]||0)+(t.quantity||0);
    details.push({ supplier:p.supplier, name:p.name, amount, quantity:t.quantity, date:t.date, time:t.time, staff:t.staffName, memo:t.memo });
  });
  return { total, totals, counts, qtys, details };
}

function updateReport(){
  const r = calcMonthly();
  byId('monthlyAmount').textContent = 'Â¥'+r.total.toLocaleString();
  byId('supplierCount').textContent = Object.keys(r.totals).length;
  byId('transactionCount').textContent = r.details.length;
  const now = new Date(); byId('lastUpdate').textContent = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;

  const tbody = byId('supplierReport'); tbody.innerHTML='';
  const entries = Object.entries(r.totals).sort((a,b)=>b[1]-a[1]);
  if(entries.length===0){
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:24px;">ä»Šæœˆã®ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>`;
    return;
  }
  entries.forEach(([s,amt])=>{
    const perc = r.total>0 ? (amt/r.total*100).toFixed(1) : 0;
    const count = r.counts[s]||0;
    const q = r.qtys[s]||0;
    const avg = q>0 ? Math.round(amt/q) : 0;
    const bar = `<div style="width:120px;height:6px;background:#eee;border-radius:4px;"><div style="width:${perc}%;height:6px;background:#8b5cf6;border-radius:4px;"></div></div>`;
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td><b>${s}</b></td><td>Â¥${amt.toLocaleString()}</td><td style="display:flex;align-items:center;gap:8px;">${perc}% ${bar}</td><td>${count}</td><td>Â¥${avg.toLocaleString()}</td>
    </tr>`);
  });
}

function updateStats(){
  byId('statProducts').textContent = products.length;
  byId('statStaff').textContent = staff.length;
  byId('statTransactions').textContent = transactions.length;
}

/* =========================
   8) å•†å“
========================= */
function showAddProduct(){ byId('addProductArea').classList.remove('hidden'); }
function hideAddProduct(){ byId('addProductArea').classList.add('hidden'); ['productName','optimalStock','unitPrice','supplier','category','alias'].forEach(id=> byId(id).value=''); }

function addProduct(){
  const name = byId('productName').value.trim();
  const optimal = parseInt(byId('optimalStock').value,10);
  const unit = parseInt(byId('unitPrice').value,10) || 0;
  const supplier = byId('supplier').value.trim();
  const category = byId('category').value;
  const alias = byId('alias').value.trim();

  if(!name || !optimal || !supplier){ alert('å•†å“åãƒ»é©æ­£åœ¨åº«ãƒ»ä»•å…¥å…ˆã¯å¿…é ˆ'); return; }
  const maxId = products.length? Math.max(...products.map(p=>p.id)): 0;
  products.push({ id:maxId+1, name, category, currentStock:0, optimalStock:optimal, unitPrice:unit, supplier, alias });
  renderProducts(); refreshSelectors(); updateDashboard(); updateReport();
  hideAddProduct();
  isCloudMode? saveToCloud(): saveAllData();
  showToast('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

function renderProducts(){
  const tb = byId('productsTable'); tb.innerHTML='';
  products.forEach(p=>{
    const row = document.createElement('tr');
    if(editingProductId===p.id){
      row.innerHTML = `
        <td><input class="edit-name" value="${p.name}"/></td>
        <td><input class="edit-supplier" value="${p.supplier}"/></td>
        <td>${p.category}</td>
        <td><input class="edit-stock" type="number" value="${p.currentStock}" style="max-width:90px;"/> æœ¬</td>
        <td><input class="edit-opt" type="number" value="${p.optimalStock}" style="max-width:90px;"/> æœ¬</td>
        <td><input class="edit-unit" type="number" value="${p.unitPrice}" style="max-width:110px;"/></td>
        <td>
          <button class="btn" onclick="saveProduct(${p.id})">ä¿å­˜</button>
          <button class="btn btn-secondary" onclick="cancelEdit()">å–æ¶ˆ</button>
        </td>`;
    }else{
      row.innerHTML = `
        <td>${p.name}${p.alias?`<br><small style="color:#6b7280;">åˆ¥å: ${p.alias}</small>`:''}</td>
        <td><b>${p.supplier}</b></td>
        <td>${p.category}</td>
        <td>${p.currentStock} æœ¬</td>
        <td>${p.optimalStock} æœ¬</td>
        <td>Â¥${(p.unitPrice||0).toLocaleString()}</td>
        <td>
          <button class="btn" onclick="editProduct(${p.id})">ç·¨é›†</button>
          <button class="btn btn-danger" onclick="deleteProduct(${p.id})">å‰Šé™¤</button>
        </td>`;
    }
    tb.appendChild(row);
  });
}

function editProduct(id){ editingProductId=id; renderProducts(); }
function cancelEdit(){ editingProductId=null; renderProducts(); }

function saveProduct(id){
  const tr = document.querySelector(`#productsTable tr:nth-child(${products.findIndex(p=>p.id===id)+1})`);
  const name = tr.querySelector('.edit-name').value.trim();
  const supplier = tr.querySelector('.edit-supplier').value.trim();
  const stock = parseInt(tr.querySelector('.edit-stock').value,10);
  const opt = parseInt(tr.querySelector('.edit-opt').value,10);
  const unit = parseInt(tr.querySelector('.edit-unit').value,10)||0;
  if(!name || !supplier){ alert('å•†å“åã¨ä»•å…¥å…ˆã¯å¿…é ˆ'); return; }
  const idx = products.findIndex(p=>p.id===id);
  products[idx] = { ...products[idx], name, supplier, currentStock:stock, optimalStock:opt, unitPrice:unit };
  editingProductId=null; renderProducts(); updateDashboard(); updateReport();
  isCloudMode? saveToCloud(): saveAllData();
  showToast('å•†å“ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}

function deleteProduct(id){
  const p = products.find(x=>x.id===id); if(!p) return;
  if(!confirm(`ã€Œ${p.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿé–¢é€£ã™ã‚‹å–å¼•ã‚‚æ¶ˆãˆã¾ã™ã€‚`)) return;
  transactions = transactions.filter(t=>t.productId!==id);
  products = products.filter(x=>x.id!==id);
  renderProducts(); renderTransactions(); refreshSelectors(); updateDashboard(); updateReport();
  isCloudMode? saveToCloud(): saveAllData();
  showToast('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

function deleteAllProducts(){
  if(!confirm(`å…¨å•†å“(${products.length})ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;
  const ids = products.map(p=>p.id);
  transactions = transactions.filter(t=> !ids.includes(t.productId));
  products = [];
  renderProducts(); renderTransactions(); refreshSelectors(); updateDashboard(); updateReport();
  isCloudMode? saveToCloud(): saveAllData();
  showToast('å…¨å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

/* =========================
   9) ã‚¹ã‚¿ãƒƒãƒ•
========================= */
function renderStaff(){
  const tb = byId('staffTable'); tb.innerHTML='';
  staff.forEach(s=>{
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${s.staffCode||''}</td><td>${s.name}</td>
      <td><span class="tag ${s.role==='åº—é•·'?'tag-purple':s.role==='ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ'?'tag-blue':'tag-green'}">${s.role||'ã‚¹ã‚¿ãƒƒãƒ•'}</span></td>
      <td>${s.joinDate||''}</td>
      <td><button class="btn btn-danger" onclick="deleteStaff(${s.id})">å‰Šé™¤</button></td>`;
    tb.appendChild(row);
  });
}

function deleteStaff(id){
  const s = staff.find(x=>x.id===id); if(!s) return;
  if(!confirm(`ã€Œ${s.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  staff = staff.filter(x=>x.id!==id);
  renderStaff(); refreshSelectors();
  isCloudMode? saveToCloud(): saveAllData();
  showToast('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

/* =========================
   10) å–å¼•
========================= */
function refreshSelectors(){
  const selP = byId('transactionProduct'); if(selP){ selP.innerHTML='<option value="">å•†å“ã‚’é¸æŠ</option>'; products.forEach(p=> selP.insertAdjacentHTML('beforeend', `<option value="${p.id}">${p.name}</option>`)); }
  const selS = byId('transactionStaff'); if(selS){ selS.innerHTML='<option value="">æ‹…å½“ã‚’é¸æŠ</option>'; staff.forEach(s=> selS.insertAdjacentHTML('beforeend', `<option>${s.name}</option>`)); }
  const ocrS = byId('ocrStaffSelect'); if(ocrS){ ocrS.innerHTML='<option value="">æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠ</option>'; staff.forEach(s=> ocrS.insertAdjacentHTML('beforeend', `<option>${s.name}</option>`)); }
}

function showAddTransaction(){ byId('addTransactionArea').classList.remove('hidden'); }
function hideAddTransaction(){ byId('addTransactionArea').classList.add('hidden'); ['transactionProduct','transactionQuantity','transactionStaff','transactionMemo'].forEach(id=>byId(id).value=''); byId('transactionType').value='use'; }

function addTransaction(){
  const productId = parseInt(byId('transactionProduct').value,10);
  const type = byId('transactionType').value;
  const qty = parseInt(byId('transactionQuantity').value,10);
  const staffName = byId('transactionStaff').value;
  const memo = byId('transactionMemo').value;
  if(!productId || !qty || !staffName){ alert('å•†å“ãƒ»æ•°é‡ãƒ»æ‹…å½“è€…ã¯å¿…é ˆ'); return; }
  const now = new Date();
  const tx = { id: Date.now(), productId, type, quantity:qty, date:fmtYmd(now), time:fmtHm(now), staffName, memo };
  transactions.unshift(tx);
  const p = products.find(x=>x.id===productId);
  if(p){
    if(type==='receipt') p.currentStock += qty;
    if(type==='use' || type==='sale') p.currentStock = Math.max(0, p.currentStock-qty);
  }
  renderTransactions(); renderProducts(); updateDashboard(); updateReport(); hideAddTransaction();
  isCloudMode? saveToCloud(): saveAllData();
  showToast('å–å¼•ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

function renderTransactions(){
  const tb = byId('transactionsTable'); tb.innerHTML='';
  const styles = { order:'tag-blue', receipt:'tag-green', use:'tag-orange', sale:'tag-purple' };
  const labels = { order:'ç™ºæ³¨', receipt:'å…¥è·', use:'ä½¿ç”¨', sale:'è²©å£²' };
  transactions.forEach(t=>{
    const p = products.find(x=>x.id===t.productId);
    const name = p? p.name: `å‰Šé™¤ã•ã‚ŒãŸå•†å“ (ID:${t.productId})`;
    tb.insertAdjacentHTML('beforeend', `<tr>
      <td>${t.date} <small>${t.time}</small></td>
      <td>${name}</td>
      <td><span class="tag ${styles[t.type]||'tag-blue'}">${labels[t.type]||t.type}</span></td>
      <td>${t.quantity}</td>
      <td>${t.staffName||''}</td>
      <td>${t.memo||''}</td>
      <td><button class="btn btn-danger" onclick="deleteTransaction(${t.id})">å‰Šé™¤</button></td>
    </tr>`);
  });
}

function deleteTransaction(id){
  const t = transactions.find(x=>x.id===id); if(!t) return;
  const p = products.find(x=>x.id===t.productId);
  if(!confirm(`ã“ã®å–å¼•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå•†å“:${p?p.name:`ID:${t.productId}`} ç¨®åˆ¥:${t.type} æ•°é‡:${t.quantity}`)) return;
  if(p){
    if(t.type==='receipt') p.currentStock = Math.max(0, p.currentStock - t.quantity);
    if(t.type==='use' || t.type==='sale') p.currentStock += t.quantity;
  }
  transactions = transactions.filter(x=>x.id!==id);
  renderTransactions(); renderProducts(); updateDashboard(); updateReport();
  isCloudMode? saveToCloud(): saveAllData();
  showToast('å–å¼•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

/* =========================
   11) CSVï¼ˆç°¡æ˜“ï¼‰
========================= */
function showCsvModal(type){
  if(!window.papaParseAvailable){ alert('CSVæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'); return; }
  currentCsvType = type;
  const input = document.createElement('input'); input.type='file'; input.accept='.csv';
  input.onchange = (e)=>{
    const file = e.target.files[0]; if(!file){return;}
    Papa.parse(file, {
      header:true, skipEmptyLines:true, dynamicTyping:true, complete: ({data})=>{
        if(type==='products'){
          data.forEach(r=>{
            if(!r.name || !r.supplier) return;
            const maxId = products.length? Math.max(...products.map(p=>p.id)):0;
            products.push({
              id:maxId+1, name:r.name, category:r.category||'ãã®ä»–',
              currentStock: Number(r.currentStock||0),
              optimalStock: Number(r.optimalStock||0),
              unitPrice: Number(r.unitPrice||0),
              supplier: r.supplier, alias: r.alias||''
            });
          });
          renderProducts(); refreshSelectors(); updateDashboard(); updateReport();
        }else{
          data.forEach(r=>{
            if(!r.name) return;
            const maxId = staff.length? Math.max(...staff.map(s=>s.id)):0;
            staff.push({ id:maxId+1, name:r.name, role:r.role||'ã‚¹ã‚¿ãƒƒãƒ•', staffCode:r.staffCode||'', joinDate:r.joinDate||'' });
          });
          renderStaff(); refreshSelectors();
        }
        isCloudMode? saveToCloud(): saveAllData();
        showToast('CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
      },
      error: (err)=> alert('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: '+err.message)
    });
  };
  input.click();
}

/* =========================
   12) ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
========================= */
function exportData(){
  const blob = new Blob([JSON.stringify({products,staff,transactions},null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='inventory_export.json'; a.click();
  URL.revokeObjectURL(url);
}
function importData(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const j=JSON.parse(r.result);
        products=j.products||[]; staff=j.staff||[]; transactions=j.transactions||[];
        renderProducts(); renderStaff(); renderTransactions(); refreshSelectors(); updateDashboard(); updateReport(); updateStats();
        isCloudMode? saveToCloud(): saveAllData();
        showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
      }catch(err){ alert('JSONã‚¨ãƒ©ãƒ¼: '+err.message); }
    };
    r.readAsText(f,'utf-8');
  };
  inp.click();
}

/* =========================
   13) OCRï¼ˆTesseract.js v4 + EXIFè£œæ­£ï¼‰
========================= */
function openOCRModal(){
  if(!window.tesseractAvailable || !window.Tesseract){ alert('OCRãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  byId('ocrPreview').classList.add('hidden');
  byId('ocrResults').classList.add('hidden');
  byId('ocrLoading').classList.add('hidden');
  byId('ocrModal').classList.add('show');
}
function closeOCRModal(){ byId('ocrModal').classList.remove('show'); }
function printOCRTemplate(){
  const w=window.open('','_blank');
  w.document.write(`<html><head><title>åœ¨åº«ä½¿ç”¨è¨˜éŒ²ã‚·ãƒ¼ãƒˆ</title></head><body style="font-family:Meiryo;font-size:16pt;line-height:2.2;padding:30px;">
    <h2 style="text-align:center;">åœ¨åº«ä½¿ç”¨è¨˜éŒ²ã‚·ãƒ¼ãƒˆ</h2>
    <p>æ—¥ä»˜: ____________ã€€æ‹…å½“: ____________</p><hr/>
    <div>â–¡ ã‚­ãƒ£ãƒ©ãƒ‡ã‚³ _______ æœ¬</div>
    <div>â–¡ OX _______ æœ¬</div>
    <div>â–¡ ãƒŸãƒ«ãƒ•ã‚£ _______ æœ¬</div>
    <div>â–¡ ã‚­ãƒ©ãƒ†ãƒ© _______ æœ¬</div>
    <div>â–¡ ã‚·ã‚§ãƒ«ãƒ‘ãƒ›ãƒ¼ãƒ ã‚±ã‚¢ _______ æœ¬</div>
    <div>â–¡ ãã®ä»–: _____________ _______ æœ¬</div>
    <hr/><p>å‚™è€ƒ: ________________________________</p>
  </body></html>`);
  w.document.close(); w.print();
}

// EXIFå›è»¢ã‚’æ­£ã—ã¦Canvasã«æç”» â†’ dataURLè¿”ã™
function loadImageWithOrientation(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = function(){
      let dataUrl = reader.result; // base64
      try{
        const exif = window.piexif? piexif.load(dataUrl): null;
        const orientation = exif? (exif['0th'][piexif.ImageIFD.Orientation] || 1) : 1;
        const img = new Image();
        img.onload = ()=>{
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          let w=img.naturalWidth, h=img.naturalHeight;
          // å›è»¢
          if(orientation>4){ canvas.width = h; canvas.height = w; }
          else { canvas.width = w; canvas.height = h; }
          switch(orientation){
            case 2: ctx.translate(w,0); ctx.scale(-1,1); break;
            case 3: ctx.translate(w,h); ctx.rotate(Math.PI); break;
            case 4: ctx.translate(0,h); ctx.scale(1,-1); break;
            case 5: ctx.rotate(0.5*Math.PI); ctx.scale(1,-1); break;
            case 6: ctx.rotate(0.5*Math.PI); ctx.translate(0,-h); break;
            case 7: ctx.rotate(0.5*Math.PI); ctx.translate(w,-h); ctx.scale(-1,1); break;
            case 8: ctx.rotate(-0.5*Math.PI); ctx.translate(-w,0); break;
          }
          // æç”»ï¼ˆç¸®å°ã—ã™ããªã„ã‚ˆã†æœ€å¤§è¾º2000pxç¨‹åº¦ã«ï¼‰
          let maxSide = 2000;
          let scale = Math.min(1, maxSide/Math.max(img.naturalWidth,img.naturalHeight));
          const dw = img.naturalWidth*scale;
          const dh = img.naturalHeight*scale;
          // orientationè€ƒæ…®ã—ã¦å†èª¿æ•´
          if(orientation>4){ canvas.width = dh; canvas.height = dw; }
          else { canvas.width = dw; canvas.height = dh; }
          ctx.setTransform(1,0,0,1,0,0);
          // å†åº¦å›è»¢é©ç”¨
          switch(orientation){
            case 2: ctx.translate(dw,0); ctx.scale(-1,1); break;
            case 3: ctx.translate(dw,dh); ctx.rotate(Math.PI); break;
            case 4: ctx.translate(0,dh); ctx.scale(1,-1); break;
            case 5: ctx.rotate(0.5*Math.PI); ctx.scale(1,-1); ctx.translate(0,-dw); break;
            case 6: ctx.rotate(0.5*Math.PI); ctx.translate(0,-dh); break;
            case 7: ctx.rotate(0.5*Math.PI); ctx.translate(dw,-dh); ctx.scale(-1,1); break;
            case 8: ctx.rotate(-0.5*Math.PI); ctx.translate(-dw,0); break;
          }
          ctx.drawImage(img,0,0,dw,dh);
          resolve(canvas.toDataURL('image/jpeg',0.9));
        };
        img.onerror = reject;
        img.src = dataUrl;
      }catch(err){
        // EXIFèª­ã‚ãªãã¦ã‚‚ãã®ã¾ã¾è¿”ã™
        resolve(dataUrl);
      }
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

let ocrWorker = null;

async function ensureOCRWorker(){
  if(ocrWorker) return ocrWorker;
  // æ—¥æœ¬èªãƒ¢ãƒ‡ãƒ«åˆ©ç”¨ï¼ˆtessdata CDNï¼‰
  ocrWorker = await Tesseract.createWorker({
    logger: m => { /* console.log(m); */ },
    langPath: 'https://tessdata.projectnaptha.com/4.0.0'
  });
  await ocrWorker.loadLanguage('jpn');
  await ocrWorker.initialize('jpn');
  // PSM=6: å˜ä¸€ãƒ–ãƒ­ãƒƒã‚¯ã®å¯èª­ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã«å‘ãï¼‰
  await ocrWorker.setParameters({ tessedit_pageseg_mode: '6' });
  return ocrWorker;
}

async function handleOCRFile(ev){
  const f = ev.target.files[0]; if(!f) return;
  const dataUrl = await loadImageWithOrientation(f);
  byId('ocrPreview').innerHTML = `<img src="${dataUrl}"/>`;
  byId('ocrPreview').classList.remove('hidden');
  byId('ocrResults').classList.add('hidden');
  byId('ocrLoading').classList.remove('hidden');

  try{
    const worker = await ensureOCRWorker();
    const { data:{ text } } = await worker.recognize(dataUrl);
    byId('ocrLoading').classList.add('hidden');
    // è§£æâ†’å€™è£œ
    const records = parseInventoryText(text);
    renderOCRTable(records);
    byId('ocrResults').classList.remove('hidden');
  }catch(e){
    byId('ocrLoading').classList.add('hidden');
    alert('OCRã‚¨ãƒ©ãƒ¼: '+e.message);
  }
}

// ãƒ†ã‚­ã‚¹ãƒˆâ†’ {name, qty, unit}[] æŠ½å‡ºï¼ˆè¦‹å‡ºã—èª + ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆæ¨å®šï¼‰
function parseInventoryText(text){
  const norm = normalizeJa(text);
  const lines = norm.split('\n').map(s=>s.trim()).filter(Boolean);
  const out = [];

  // 1) è¡Œã”ã¨ã®ã€Œå•†å“å ... æ•°é‡ ... å˜ä½ã€ãƒ‘ã‚¿ãƒ¼ãƒ³
  const rowRe = /(.*?)(?:[:ï¼š\s\-]*)(\d+(?:\.\d+)?)[\s]*(ml|g|æœ¬|å€‹)?$/i;

  // 2) è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«
  let current = {name:'', qty:null, unit:''};
  lines.forEach(line=>{
    // è¦‹å‡ºã—
    const kv = /^(å•†å“å|å“å)[:ï¼š]\s*(.+)$/.exec(line);
    if(kv){ current.name = kv[2]; return; }
    const qv = /^(æ•°é‡|å€‹æ•°)[:ï¼š]\s*(\d+(?:\.\d+)?)/.exec(line);
    if(qv){ current.qty = Number(qv[2]); return; }
    const uv = /^(å˜ä½)[:ï¼š]\s*(ml|g|æœ¬|å€‹)/i.exec(line);
    if(uv){ current.unit = uv[2]; return; }

    // 1è¡Œãƒ‘ã‚¿ãƒ¼ãƒ³
    const m = rowRe.exec(line);
    if(m){
      out.push({ name:m[1].trim(), qty: Number(m[2]), unit: (m[3]||'æœ¬') });
      current = {name:'', qty:null, unit:''};
    }
  });
  if(current.name && current.qty){ out.push(current); }

  // 3) å•†å“ãƒã‚¹ã‚¿ã¨ç…§åˆï¼ˆã‚†ã‚‹ãµã‚ä¸€è‡´ï¼‰
  return out.map(r=>{
    const match = fuzzyProductMatch(r.name);
    return { name: match? match.name: r.name, qty: r.qty||1, unit: r.unit||'æœ¬', productId: match? match.id: null };
  });
}

function normalizeJa(s){
  return s.replace(/\r/g,'')
    .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0))
    .replace(/[â€ï¼ãƒ¼â€•]/g,'-')
    .replace(/[ \t]+/g,' ')
    .replace(/\u3000/g,' ')
    .trim();
}

// å•†å“åã®ãƒ•ã‚¡ã‚¸ãƒ¼ãƒãƒƒãƒï¼ˆã‚¨ã‚¤ãƒªã‚¢ã‚¹åˆ—ã‚‚ä½¿ç”¨ï¼‰
function fuzzyProductMatch(query){
  const q = normalizeJa(query).toLowerCase();
  if(!q) return null;
  let best=null, bestScore=1e9;
  products.forEach(p=>{
    const names = [p.name, ...(p.alias? p.alias.split(',').map(s=>s.trim()): [])];
    names.forEach(n=>{
      const sc = lev(q, normalizeJa(n).toLowerCase());
      if(sc<bestScore){ bestScore=sc; best=p; }
    });
  });
  // é–¾å€¤ã¯é©å®œèª¿æ•´ï¼ˆçŸ­æ–‡ãªã®ã§è·é›¢3ä»¥å†…ï¼‰
  return (bestScore<=3) ? best : null;
}

function lev(a,b){
  const m = Array(a.length+1).fill(null).map(()=>Array(b.length+1).fill(0));
  for(let i=0;i<=a.length;i++) m[i][0]=i;
  for(let j=0;j<=b.length;j++) m[0][j]=j;
  for(let i=1;i<=a.length;i++){
    for(let j=1;j<=b.length;j++){
      const c = a[i-1]===b[j-1]?0:1;
      m[i][j] = Math.min(m[i-1][j]+1, m[i][j-1]+1, m[i-1][j-1]+c);
    }
  }
  return m[a.length][b.length];
}

function renderOCRTable(records){
  const tb = byId('ocrTableBody'); tb.innerHTML='';
  records.forEach((r,idx)=>{
    const selId = `ocrProdSel_${idx}`;
    const qtyId = `ocrQty_${idx}`;
    const unitId = `ocrUnit_${idx}`;
    // å•†å“å€™è£œã‚»ãƒ¬ã‚¯ãƒˆ
    let opts = `<option value="">ï¼ˆå€™è£œã‹ã‚‰é¸æŠï¼‰</option>`;
    products.forEach(p=>{
      const selected = (r.productId===p.id)? 'selected':'';
      opts += `<option value="${p.id}" ${selected}>${p.name}</option>`;
    });
    tb.insertAdjacentHTML('beforeend', `<tr>
      <td>
        <div style="display:flex; gap:6px;">
          <select id="${selId}" style="min-width:260px;">${opts}</select>
          <input type="text" value="${r.name||''}" data-free-name="${idx}" placeholder="ãƒ•ãƒªãƒ¼å…¥åŠ›ï¼ˆå€™è£œãªã—æ™‚ï¼‰" />
        </div>
      </td>
      <td><input id="${qtyId}" type="number" value="${r.qty||1}" style="max-width:100px; text-align:right;"></td>
      <td>
        <select id="${unitId}" style="max-width:110px;">
          ${['æœ¬','å€‹','ml','g'].map(u=>`<option ${r.unit===u?'selected':''}>${u}</option>`).join('')}
        </select>
      </td>
      <td><button class="btn btn-danger" onclick="this.closest('tr').remove()">å‰Šé™¤</button></td>
    </tr>`);
  });
}

function addOCRRow(){
  renderOCRTable([{name:'',qty:1,unit:'æœ¬',productId:null}].concat(getOCRRows()));
}

function getOCRRows(){
  const rows = [];
  const tb = byId('ocrTableBody');
  [...tb.querySelectorAll('tr')].forEach((tr,idx)=>{
    const sel = tr.querySelector('select[id^="ocrProdSel_"]');
    const nameInput = tr.querySelector('input[type="text"]');
    const qty = parseInt(tr.querySelector('input[type="number"]').value,10)||1;
    const unit = tr.querySelector('select[id^="ocrUnit_"]').value;
    const pid = sel.value? Number(sel.value): null;
    const name = pid? (products.find(p=>p.id===pid)?.name||'') : (nameInput.value.trim()||'');
    rows.push({ productId: pid, name, qty, unit });
  });
  return rows;
}

function confirmOCRRecords(){
  const staffName = byId('ocrStaffSelect').value;
  if(!staffName){ alert('æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const rows = getOCRRows().filter(r=> (r.productId || r.name) && r.qty>0);
  if(rows.length===0){ alert('ç™»éŒ²å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const now = new Date();
  rows.forEach(r=>{
    let pid = r.productId;
    // å€™è£œãŒãªã‘ã‚Œã°åå‰ã‹ã‚‰æ–°è¦å•†å“ï¼ˆã¨ã‚Šã‚ãˆãšã‚«ãƒ†ã‚´ãƒªãã®ä»–ï¼‰
    if(!pid){
      const maxId = products.length? Math.max(...products.map(p=>p.id)) : 0;
      const newP = { id:maxId+1, name:r.name, category:'ãã®ä»–', currentStock:0, optimalStock:0, unitPrice:0, supplier:'', alias:'' };
      products.push(newP); pid = newP.id;
    }
    transactions.unshift({
      id: Date.now()+Math.floor(Math.random()*1000),
      productId: pid, type:'use', quantity:r.qty,
      date: fmtYmd(now), time: fmtHm(now),
      staffName, memo: `OCR(${r.unit})`
    });
    const p = products.find(x=>x.id===pid);
    if(p) p.currentStock = Math.max(0, (p.currentStock||0) - r.qty);
  });
  renderTransactions(); renderProducts(); updateDashboard(); updateReport();
  isCloudMode? saveToCloud(): saveAllData();
  closeOCRModal();
  showToast('âœ… OCRçµæœã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
}

/* =========================
   14) èµ·å‹•æ™‚ã«Firebaseè¨­å®šå¾©å…ƒ
========================= */
(function boot(){
  const cfg = loadLocal('firebaseConfig');
  if(cfg && window.firebaseAvailable){
    try{ firebase.initializeApp(cfg); db=firebase.firestore(); isCloudMode=true; byId('modeText').textContent='ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ'; byId('cloudStatus').textContent='æ¥ç¶šæ¸ˆã¿'; }catch(e){}
  }
})();
</script>
</body>
</html>
